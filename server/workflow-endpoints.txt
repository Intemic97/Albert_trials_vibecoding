// Workflow Management Endpoints
app.get('/api/workflows', async (req, res) => {
    try {
        const workflows = await db.all('SELECT id, name, createdAt, updatedAt FROM workflows ORDER BY updatedAt DESC');
        res.json(workflows);
    } catch (error) {
        console.error('Error fetching workflows:', error);
        res.status(500).json({ error: 'Failed to fetch workflows' });
    }
});

app.get('/api/workflows/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const workflow = await db.get('SELECT * FROM workflows WHERE id = ?', [id]);
        if (!workflow) {
            return res.status(404).json({ error: 'Workflow not found' });
        }
        // Parse JSON data before sending
        workflow.data = JSON.parse(workflow.data);
        res.json(workflow);
    } catch (error) {
        console.error('Error fetching workflow:', error);
        res.status(500).json({ error: 'Failed to fetch workflow' });
    }
});

app.post('/api/workflows', async (req, res) => {
    try {
        const { name, data } = req.body;
        const id = Math.random().toString(36).substr(2, 9);
        const now = new Date().toISOString();
        
        // Store data as JSON string
        await db.run(
            'INSERT INTO workflows (id, name, data, createdAt, updatedAt) VALUES (?, ?, ?, ?, ?)',
            [id, name, JSON.stringify(data), now, now]
        );
        
        res.json({ id, name, createdAt: now, updatedAt: now });
    } catch (error) {
        console.error('Error saving workflow:', error);
        res.status(500).json({ error: 'Failed to save workflow' });
    }
});

app.put('/api/workflows/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const { name, data } = req.body;
        const now = new Date().toISOString();
        
        await db.run(
            'UPDATE workflows SET name = ?, data = ?, updatedAt = ? WHERE id = ?',
            [name, JSON.stringify(data), now, id]
        );
        
        res.json({ message: 'Workflow updated' });
    } catch (error) {
        console.error('Error updating workflow:', error);
        res.status(500).json({ error: 'Failed to update workflow' });
    }
});

app.delete('/api/workflows/:id', async (req, res) => {
    try {
        const { id } = req.params;
        await db.run('DELETE FROM workflows WHERE id = ?', [id]);
        res.json({ message: 'Workflow deleted' });
    } catch (error) {
        console.error('Error deleting workflow:', error);
        res.status(500).json({ error: 'Failed to delete workflow' });
    }
});
